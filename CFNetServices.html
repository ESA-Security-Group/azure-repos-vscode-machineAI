<!DOCTYPE html>
<html lang="en">
<head>

    <title>Using CFNetServices</title>
    <meta http-equiv="X-UA-Compatible" content="IE=7">
    <meta charset="utf-8">
    <meta id="book-resource-type" name="book-resource-type" content="Guide">
    <meta scheme="apple_ref" id="identifier" name="identifier" content="//apple_ref/doc/uid/TP40002736">
    <meta id="document-version" name="document-version" content="1.8.2">
    <meta id="build" name="build" content="c1e4c7a89af8f899a21cfa81fc33ba42" />
    <meta id="chapterId" name="chapterId" content="30001276">
    <meta id="date" name="date" content="2013-08-08">
    <meta id="description" name="description" content="Explains how to implement Bonjour in Cocoa or Carbon apps.">
    <meta id="book-title" name="book-title" content="NSNetServices and CFNetServices Programming Guide">
    <meta id="book-root" name="book-root" content="../">
    <meta id="book-json" name="book-json" content="../book.json">
    <meta id="devcenter" name="devcenter" content="Mac Dev Center">
    <meta id="devcenter-url" name="devcenter-url" content="http://developer.apple.com/devcenter/mac">
    <meta id="reflib" name="reflib" content="Documentation Archive">
    <meta id="book-assignments" name="book-assignments" content="{Type/Guide}, {Topic/Networking, Internet, & Web/Services & Discovery}">
    
    
    <meta id="copyright" name="copyright" content="Copyright 2018 Apple Inc. All Rights Reserved.">
    <meta id="xcode-display" name="xcode-display" content="render">
    <meta id="IndexTitle" name="IndexTitle" content="NSNetServices and CFNetServices Programming Guide: Using CFNetServices">
    <meta id="resources-uri" name="resources-uri" content="../../../../../Resources/1282">
    <link id="book-index-page" rel="Start" title="NSNetServices and CFNetServices Programming Guide" type="text/html" href="../index.html">
    <link id="next-page" rel="Next" type="text/html" href="BrowsingForDomains.html">
    <link id="previous-page" rel="Prev" type="text/html" href="ResolvingServices.html">
    <link rel="stylesheet" type="text/css" href="../../../../../Resources/1282/CSS/screen.css">
    
    <!-- xcode_css -->
    <link rel="stylesheet" type="text/css" href="../../../../../Resources/1282/CSS/feedback.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta id="platforms" name="platforms" content="">
</head>    
<body><a name="//apple_ref/doc/uid/30001276" title="Using CFNetServices"></a>
    <div id="_omniture_top">
    <!-- SiteCatalyst code version: H.8. Copyright 1997-2006 Omniture, Inc. -->
    <script type="text/javascript">
    /* RSID: */
    var s_account="appleglobal,appleusdeveloper,dappdeveloperlib"
    </script>

    <script type="text/javascript" src="https://www.apple.com/metrics/scripts/s_code_h.js"></script>
    <script type="text/javascript">
    s.pageName=AC.Tracking.pageName();
    s.channel="www.us.developer"

    /************* DO NOT ALTER ANYTHING BELOW THIS LINE ! **************/
    var s_code=s.t();if(s_code)document.write(s_code)</script>
    <!-- End SiteCatalyst code version: H.8. -->
    </div>

    <div id="adcHeader" class="hideOnPrint hideInXcode">
        <div id='ssi_Header' class="hideInXcode unified">
            <a id="ssi_LibraryTitle" href='../../../../../navigation/'>Documentation Archive</a>
            <a id="ssi_AppleDeveloperConnection" href='https://developer.apple.com/'>Developer</a>
            <div id='ssi_SearchButton' role="button" title="Search">Search</div>
        </div>
        <form id='ssi_SearchMenu' method='get' action='../../../../../search/' accept-charset='utf-8'>
            <label for='adcsearch'>Search Documentation Archive</label>
            
            
    
            <input type='search' id='ssi_SearchField' name='q' accesskey='s' results='5' />
        </form>
    </div>

    <header id="header">
        <div id="title" role="banner">
            <h1>NSNetServices and CFNetServices Programming Guide</h1>
            <span id="file_links">
                <a id="PDF_link" role="button" tabindex='4' rel="alternate" title="Download PDF"><span id="pdf_icon"></span>PDF</a>
                <a id="Companion_link" role="button" tabindex='3' title="Download Companion File"><span id="companion_icon"></span>Companion File</a>
            </span>
        </div>
        <ul id="headerButtons" class="hideOnPrint" role="toolbar">
            <li id="toc_button" style="display:none">
                <button tabindex="5" id="table_of_contents" class="open" role="checkbox" aria-label="Show Table of Contents"><span class="disclosure"></span>Table of Contents</button>
            </li>
            <li id="jumpto_button" style="display:none" role="navigation"><select tabindex="6" id="jumpTo"><option value="top">Jump To&#133;</option></select></li>
            <li id="downloadSample_button" style="display:none">
                <a id="Sample_link"><button id="Sample_button">Download Sample Code</button></a>
            </li>
        </ul>
    </header>
    <nav id="tocContainer" tabindex="7">
        <ul id="toc" role="tree"></ul>
    </nav>

    <article id="contents" tabindex="0" role="main">
        <div id="pageNavigationLinks_top" class="pageNavigationLinks">
            <a class='nextLink' rel='next' href='BrowsingForDomains.html'>Next</a><a class='previousLink' rel='prev' href='ResolvingServices.html'>Previous</a>
        </div>
        <a id="top" name="top"></a>
        <a id="INDEX" href="../index.html" style="display:none;"></a>
        
        <a name="//apple_ref/doc/uid/30001276-SW3" title="Using CFNetServices"></a><h1 id="pageTitle">Using CFNetServices</h1><p><code>CFNetServices</code> is an API in the <code>CFNetwork</code> framework (Core Foundation level) that allows you to publish or search for network services.</p><div class="importantbox clear"><aside><a name="//apple_ref/doc/uid/30001276-DontLinkElementID_7" title="Important"></a><p><strong>Important:</strong>&nbsp;Using the <code>CFNetServices</code> API is generally discouraged unless you are writing code based on Core Foundation and have a strict policy of avoiding Objective-C. For all other software, the Foundation-based NSNetServices API or the DNS Service Discovery C API is generally a better choice. If you want a high-level API, use NSNetServices. If you want a C API, use DNS Service Discovery.</p><p></p></aside></div><p>At a high level, the <code>CFNetServices</code> API provides access to Bonjour through three objects:</p><ul class="ul"><li class="li"><p><code>CFNetService</code>—An object that represents a single service on the network. A <code>CFNetService</code> object has a name, a type, a domain, and a port number. Service types used by <code>CFNetServices</code> are maintained at <span class="content_text"><a href="http://www.dns-sd.org/servicetypes.html" class="urlLink" rel="external">http://www.dns-sd.org/servicetypes.html</a></span>.</p></li><li class="li"><p><code>CFNetServiceBrowser</code>—An object used to discover domains and discover network services within domains.</p></li><li class="li"><p><code>CFNetServiceMonitor</code>—An object used to monitor services for changes to their TXT records.</p></li></ul><section><a name="//apple_ref/doc/uid/30001276-SW8" title="Publishing a Service Using CFNetServices"></a><h2 class="jump">Publishing a Service Using CFNetServices</h2><p>Publishing a service on the network involves two tasks: creating a service and registering a service. The next two sections describe what is required to perform these two tasks.</p><section><a name="//apple_ref/doc/uid/30001276-SW9" title="Creating a CFNetService Object"></a><h3 class="jump">Creating a CFNetService Object</h3><p>To create a <code>CFNetService</code> object, call <code><a href="https://developer.apple.com/documentation/cfnetwork/1426628-cfnetservicecreate" class="urlLink" target="_self">CFNetServiceCreate</a></code> and provide the following information about the service:</p><ul class="ul"><li class="li"><p><strong>Name.</strong> The human-readable name of the service (such as “<code>Sales Laser Printer</code>”)</p></li><li class="li"><p><strong>Service Type.</strong> The type of service, such as “<code>_printer._tcp</code>“; </p></li><li class="li"><p><strong>Domain.</strong> The domain for the service, typically the empty string (<code>CFSTR("")</code>)for default domain(s), or <code>local.</code> for the local domain only</p></li><li class="li"><p><strong>Port.</strong> The port number the service listens on</p></li></ul><div class="notebox"><aside><a name="//apple_ref/doc/uid/30001276-SW10" title="Note"></a><p><strong>Note:</strong>&nbsp;The dot in “<code>local.</code>“ is part of the domain name. It signifies that the domain is fully qualified, which prevents anything from being added to the end of the domain (for example, <code>local.com</code>).</p><p></p></aside></div><p>If you are implementing a protocol that relies on data stored in DNS text records, you can associate that information with a <code>CFNetService</code> object by calling <code><a href="https://developer.apple.com/documentation/cfnetwork/1426670-cfnetservicesettxtdata" class="urlLink" target="_self">CFNetServiceSetTXTData</a></code>).</p><p>Associate a callback function with your <code>CFNetService</code> object by calling <code><a href="https://developer.apple.com/documentation/cfnetwork/1426447-cfnetservicesetclient" class="urlLink" target="_self">CFNetServiceSetClient</a></code>. Your callback function is called to report errors that occur while your service is running and to report on the status of publication.</p><p>If you want the service to run asynchronously, you must also schedule the service on a run loop by calling <code><a href="https://developer.apple.com/documentation/cfnetwork/1426730-cfnetserviceschedulewithrunloop" class="urlLink" target="_self">CFNetServiceScheduleWithRunLoop</a></code>; otherwise, the service will run synchronously. For more information about the modes in which a service can run, see<span class="content_text"><a href="#//apple_ref/doc/uid/30001276-BGBBIFDB" data-renderer-version="1">Asynchronous and Synchronous Modes</a></span>.</p><p><span class="content_text">Listing A-1</span> shows how to create a <code>CFNetService</code> object.</p><a name="//apple_ref/doc/uid/30001276-SW11" title="Listing A-1Creating a CFNetService object"></a><p class="codesample clear"><strong class="caption_number">Listing A-1</strong>&nbsp;&nbsp;Creating a <code>CFNetService</code> object</p><div class="codesample clear"><table><tr><td scope="row"><pre>    CFStringRef serviceType = CFSTR("_printer._tcp");<span></span></pre></td></tr><tr><td scope="row"><pre>    CFStringRef serviceName = CFSTR("Sales Laser Printer");<span></span></pre></td></tr><tr><td scope="row"><pre>    CFStringRef theDomain = CFSTR("");<span></span></pre></td></tr><tr><td scope="row"><pre>    int chosenPort = 515;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    CFNetServiceRef netService = CFNetServiceCreate(NULL, theDomain, serviceType, serviceName, chosenPort);<span></span></pre></td></tr></table></div></section><section><a name="//apple_ref/doc/uid/30001276-SW12" title="Registering a CFNetService"></a><h3 class="jump">Registering a CFNetService</h3><p>To make a service available on the network, call <code><a href="https://developer.apple.com/documentation/cfnetwork/1426790-cfnetserviceregisterwithoptions" class="urlLink" target="_self">CFNetServiceRegisterWithOptions</a></code>. (This operation is also known as “publishing” a service.) The service can then be found by clients until you unregister the service by calling <code><a href="https://developer.apple.com/documentation/cfnetwork/1426533-cfnetservicecancel" class="urlLink" target="_self">CFNetServiceCancel</a></code>.</p><p>See <span class="content_text">Listing A-2</span> for sample code on this subject.</p><a name="//apple_ref/doc/uid/30001276-SW1" title="Listing A-2Registering an asynchronous service"></a><p class="codesample clear"><strong class="caption_number">Listing A-2</strong>&nbsp;&nbsp;Registering an asynchronous service</p><div class="codesample clear"><table><tr><td scope="row"><pre>void registerCallback (<span></span></pre></td></tr><tr><td scope="row"><pre>   CFNetServiceRef theService,<span></span></pre></td></tr><tr><td scope="row"><pre>   CFStreamError* error,<span></span></pre></td></tr><tr><td scope="row"><pre>   void* info)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    // ...<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>void startBonjour (CFNetServiceRef netService) {<span></span></pre></td></tr><tr><td scope="row"><pre>   CFStreamError error;<span></span></pre></td></tr><tr><td scope="row"><pre>   CFNetServiceClientContext clientContext = { 0, NULL, NULL, NULL, NULL };<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>   CFNetServiceSetClient(netService, registerCallback, &amp;clientContext);<span></span></pre></td></tr><tr><td scope="row"><pre>   CFNetServiceScheduleWithRunLoop(netService, CFRunLoopGetCurrent(), kCFRunLoopCommonModes);<span></span></pre></td></tr><tr><td scope="row"><pre>   CFOptionFlags options = 0; // or kCFNetServiceFlagNoAutoRename<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>   if (CFNetServiceRegisterWithOptions(netService, options, &amp;error) == false) {<span></span></pre></td></tr><tr><td scope="row"><pre>     CFNetServiceUnscheduleFromRunLoop(netService, CFRunLoopGetCurrent(),kCFRunLoopCommonModes);<span></span></pre></td></tr><tr><td scope="row"><pre>     CFNetServiceSetClient(netService, NULL, NULL);<span></span></pre></td></tr><tr><td scope="row"><pre>     CFRelease(netService);<span></span></pre></td></tr><tr><td scope="row"><pre>     fprintf(stderr, "could not register Bonjour service");<span></span></pre></td></tr><tr><td scope="row"><pre>   }<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></section></section><section><a name="//apple_ref/doc/uid/30001276-BGBIAACH" title="Browsing for Services using CFNetServices"></a><h2 class="jump">Browsing for Services using CFNetServices</h2><p>To browse for services represented by a <code>CFNetService</code> object, call <code><a href="https://developer.apple.com/documentation/cfnetwork/1426560-cfnetservicebrowsercreate" class="urlLink" target="_self">CFNetServiceBrowserCreate</a></code> and provide a pointer to a callback function that will be called as services are found.</p><p>If you want searches to be conducted asynchronously, you must also schedule the browser on a run loop by calling <code><a href="https://developer.apple.com/documentation/cfnetwork/1426904-cfnetservicebrowserschedulewithr" class="urlLink" target="_self">CFNetServiceBrowserScheduleWithRunLoop</a></code>.</p><p>To browse for services, you can call <code><a href="https://developer.apple.com/documentation/cfnetwork/1426405-cfnetservicebrowsersearchforserv" class="urlLink" target="_self">CFNetServiceBrowserSearchForServices</a></code> and specify the services to search for. For the domain parameter, you have two options. It is recommended that you pass the empty string (<code>CFSTR("")</code>) as the domain, allowing you to discover services in any domain on which your system is registered. Alternatively, you can specify a domain to search in. Your callback function will be called and passed a <code>CFNetService</code> object representing a matching service. The <code>CFNetServiceBrowser</code> object continues searching until your app stops the search by calling <code><a href="https://developer.apple.com/documentation/cfnetwork/1426523-cfnetservicebrowserstopsearch" class="urlLink" target="_self">CFNetServiceBrowserStopSearch</a></code>.</p><p>For each <code>CFNetService</code> object that your callback function receives, you can call <code><a href="https://developer.apple.com/documentation/cfnetwork/1426563-cfnetserviceresolvewithtimeout" class="urlLink" target="_self">CFNetServiceResolveWithTimeout</a></code> to update the service with the IP address for the service. Then call <code><a href="https://developer.apple.com/documentation/cfnetwork/1426743-cfnetservicegetaddressing" class="urlLink" target="_self">CFNetServiceGetAddressing</a></code> to get an array of <code>CFDataRef</code> objects, one for each IP address associated with the service. Each <code>CFDataRef</code> object, in turn, contains a <code>sockaddr</code> structure with an IP address.</p><p>A good example of how to browse for services can be seen in <span class="content_text">Listing A-3</span>.</p><a name="//apple_ref/doc/uid/30001276-SW2" title="Listing A-3Browsing asynchronously for services"></a><p class="codesample clear"><strong class="caption_number">Listing A-3</strong>&nbsp;&nbsp;Browsing asynchronously for services</p><div class="codesample clear"><table><tr><td scope="row"><pre>void MyBrowseCallBack (<span></span></pre></td></tr><tr><td scope="row"><pre>   CFNetServiceBrowserRef browser,<span></span></pre></td></tr><tr><td scope="row"><pre>   CFOptionFlags flags,<span></span></pre></td></tr><tr><td scope="row"><pre>   CFTypeRef domainOrService,<span></span></pre></td></tr><tr><td scope="row"><pre>   CFStreamError* error,<span></span></pre></td></tr><tr><td scope="row"><pre>   void* info)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    // ...<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>static Boolean MyStartBrowsingForServices(CFStringRef type, CFStringRef domain) {<span></span></pre></td></tr><tr><td scope="row"><pre>     CFNetServiceClientContext clientContext = { 0, NULL, NULL, NULL, NULL };<span></span></pre></td></tr><tr><td scope="row"><pre>     CFStreamError error;<span></span></pre></td></tr><tr><td scope="row"><pre>     Boolean result;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>     assert(type != NULL);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>     CFNetServiceBrowserRef gServiceBrowserRef = CFNetServiceBrowserCreate(kCFAllocatorDefault, MyBrowseCallBack, &amp;clientContext);<span></span></pre></td></tr><tr><td scope="row"><pre>     assert(gServiceBrowserRef != NULL);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>     CFNetServiceBrowserScheduleWithRunLoop(gServiceBrowserRef, CFRunLoopGetCurrent(), kCFRunLoopCommonModes);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>     result = CFNetServiceBrowserSearchForServices(gServiceBrowserRef, domain, type, &amp;error);<span></span></pre></td></tr><tr><td scope="row"><pre>     if (result == false) {<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>         // Something went wrong, so let's clean up.<span></span></pre></td></tr><tr><td scope="row"><pre>         CFNetServiceBrowserUnscheduleFromRunLoop(gServiceBrowserRef, CFRunLoopGetCurrent(), kCFRunLoopCommonModes);         CFRelease(gServiceBrowserRef);<span></span></pre></td></tr><tr><td scope="row"><pre>         gServiceBrowserRef = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>         fprintf(stderr, "CFNetServiceBrowserSearchForServices returned (domain = %ld, error = %d)\n", (long)error.domain, error.error);<span></span></pre></td></tr><tr><td scope="row"><pre>     }<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>     return result;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></section><section><a name="//apple_ref/doc/uid/30001276-SW13" title="Resolving a Service Using CFNetServices"></a><h2 class="jump">Resolving a Service Using CFNetServices</h2><p>After you have a name, type, and domain, you can resolve the service to retrieve its hostname and port. As with registering a service, resolving a service also requires a <code>CFNetServiceRef</code> object. If you already have one (typically obtained through a browse operation callback), you don’t need to take any further action. Otherwise, you can create one yourself by calling <code><!--a-->CFNetServiceCreate<!--/a--></code>.</p><div class="importantbox clear"><aside><a name="//apple_ref/doc/uid/30001276-DontLinkElementID_8" title="Important"></a><p><strong>Important:</strong>&nbsp;If you create a <code>CFNetServiceRef</code> object yourself with the intent to use that object to resolve a service, you <em>must</em> pass a valid domain that was obtained when the service was first detected during browsing. Bonjour has no way to guess which domain you want to use when resolving the service name.</p><p></p></aside></div><p>If you plan to resolve a service asynchronously, associate the newly created <code>CFNetServiceRef</code> object with a callback function, which will receive a <code>CFNetServiceRef</code> object and a pointer to a <code>CFStreamError</code> object. You can set this callback by calling <code><a href="https://developer.apple.com/documentation/cfnetwork/1426447-cfnetservicesetclient" class="urlLink" target="_self">CFNetServiceSetClient</a></code>. Be sure to call <code><a href="https://developer.apple.com/documentation/cfnetwork/1426730-cfnetserviceschedulewithrunloop" class="urlLink" target="_self">CFNetServiceScheduleWithRunLoop</a></code> afterward to add the service to a run loop (which is typically the result of a call to <code><a href="https://developer.apple.com/documentation/corefoundation/1542428-cfrunloopgetcurrent" class="urlLink" target="_self">CFRunLoopGetCurrent</a></code>).</p><p>After setting up the run loop, call <code><a href="https://developer.apple.com/documentation/cfnetwork/1574815-cfnetserviceresolve" class="urlLink" target="_self">CFNetServiceResolve</a></code>. If this call returns an error, you should clean up all the references you created. Otherwise, just wait for your callback functions to be called.</p><p>An example of resolving a service with <code>CFNetService</code> is in <span class="content_text">Listing A-4</span>.</p><a name="//apple_ref/doc/uid/30001276-SW5" title="Listing A-4Resolving a service asynchronously"></a><p class="codesample clear"><strong class="caption_number">Listing A-4</strong>&nbsp;&nbsp;Resolving a service asynchronously</p><div class="codesample clear"><table><tr><td scope="row"><pre>void MyResolveCallback (<span></span></pre></td></tr><tr><td scope="row"><pre>   CFNetServiceRef theService,<span></span></pre></td></tr><tr><td scope="row"><pre>   CFStreamError* error,<span></span></pre></td></tr><tr><td scope="row"><pre>   void* info)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    // ...<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>static void MyResolveService(CFStringRef name, CFStringRef type, CFStringRef domain)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>    CFNetServiceClientContext context = { 0, NULL, NULL, NULL, NULL };<span></span></pre></td></tr><tr><td scope="row"><pre>    CFTimeInterval duration = 0; // use infinite timeout<span></span></pre></td></tr><tr><td scope="row"><pre>    CFStreamError error;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    CFNetServiceRef gServiceBeingResolved = CFNetServiceCreate(kCFAllocatorDefault, domain, type, name, 0);<span></span></pre></td></tr><tr><td scope="row"><pre>    assert(gServiceBeingResolved != NULL);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    CFNetServiceSetClient(gServiceBeingResolved, MyResolveCallback, &amp;context);<span></span></pre></td></tr><tr><td scope="row"><pre>    CFNetServiceScheduleWithRunLoop(gServiceBeingResolved, CFRunLoopGetCurrent(), kCFRunLoopCommonModes);<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    if (CFNetServiceResolveWithTimeout(gServiceBeingResolved, duration, &amp;error) == false) {<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>         // Something went wrong, so let's clean up.<span></span></pre></td></tr><tr><td scope="row"><pre>         CFNetServiceUnscheduleFromRunLoop(gServiceBeingResolved, CFRunLoopGetCurrent(), kCFRunLoopCommonModes);<span></span></pre></td></tr><tr><td scope="row"><pre>         CFNetServiceSetClient(gServiceBeingResolved, NULL, NULL);<span></span></pre></td></tr><tr><td scope="row"><pre>         CFRelease(gServiceBeingResolved);<span></span></pre></td></tr><tr><td scope="row"><pre>         gServiceBeingResolved = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>         fprintf(stderr, "CFNetServiceResolve returned (domain = %ld, error = %d)\n", (long)error.domain, error.error);<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr><tr><td scope="row"><pre> <span></span></pre></td></tr><tr><td scope="row"><pre>    return;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></section><section><a name="//apple_ref/doc/uid/30001276-SW14" title="Monitoring a Service Using CFNetServices"></a><h2 class="jump">Monitoring a Service Using CFNetServices</h2><p><code>CFNetServiceMonitor</code> lets you watch services for changes to <code>TXT</code> records.</p><p>In the app that is publishing a service, you can provide a custom <code>TXT</code> record by calling <code><a href="https://developer.apple.com/documentation/cfnetwork/1426670-cfnetservicesettxtdata" class="urlLink" target="_self">CFNetServiceSetTXTData</a></code>. The most straightforward way to provide spec-compliant data is by calling <code><a href="https://developer.apple.com/documentation/cfnetwork/1426572-cfnetservicecreatetxtdatawithdic" class="urlLink" target="_self">CFNetServiceCreateTXTDataWithDictionary</a></code> and passing it a dictionary of values to publish.</p><p>In the app that needs to monitor a service, perform the following steps:</p><ol class="ol"><li class="li"><p>After you have a <code>CFNetServiceRef</code> object for the service you wish to monitor, create a monitor reference (<code>CFNetServiceMonitorRef</code>) by calling <code><a href="https://developer.apple.com/documentation/cfnetwork/1426665-cfnetservicemonitorcreate" class="urlLink" target="_self">CFNetServiceMonitorCreate</a></code>.</p></li><li class="li"><p>Schedule the monitor reference on a run loop with <code><a href="https://developer.apple.com/documentation/cfnetwork/1426880-cfnetservicemonitorschedulewithr" class="urlLink" target="_self">CFNetServiceMonitorScheduleWithRunLoop</a></code>. (You can obtain the default run loop by calling <code><a href="https://developer.apple.com/documentation/corefoundation/1542428-cfrunloopgetcurrent" class="urlLink" target="_self">CFRunLoopGetCurrent</a></code>.)</p></li><li class="li"><p>Start the monitor by calling <code><a href="https://developer.apple.com/documentation/cfnetwork/1426842-cfnetservicemonitorstart" class="urlLink" target="_self">CFNetServiceMonitorStart</a></code>, passing it the monitor reference and a callback function to handle the resulting data. Be sure to check the return value to ensure that the monitor started successfully.</p></li><li class="li"><p>In the callback function, the most straightforward way to handle the <code>TXT</code> data is by calling <code><a href="https://developer.apple.com/documentation/cfnetwork/1426852-cfnetservicecreatedictionarywith" class="urlLink" target="_self">CFNetServiceCreateDictionaryWithTXTData</a></code> to obtain a dictionary containing the original key-value pairs.</p></li></ol><p>When you no longer need to monitor a service, call <code><a href="https://developer.apple.com/documentation/cfnetwork/1426696-cfnetservicemonitorstop" class="urlLink" target="_self">CFNetServiceMonitorStop</a></code> (to stop the monitoring), <code><a href="https://developer.apple.com/documentation/cfnetwork/1426400-cfnetservicemonitorunschedulefro" class="urlLink" target="_self">CFNetServiceMonitorUnscheduleFromRunLoop</a></code> (to unschedule your monitor from its run loop), and <code><a href="https://developer.apple.com/documentation/cfnetwork/1426906-cfnetservicemonitorinvalidate" class="urlLink" target="_self">CFNetServiceMonitorInvalidate</a></code> (to destroy the monitor reference).</p><div class="importantbox clear"><aside><a name="//apple_ref/doc/uid/30001276-DontLinkElementID_9" title="Important"></a><p><strong>Important:</strong>&nbsp;The length restrictions and other limitations described in <span class="content_text"><a href="ResolvingServices.html#//apple_ref/doc/uid/20001078-SW3" data-renderer-version="1">Monitoring a Bonjour Service</a></span> also apply to this API.</p><p></p></aside></div></section><section><a name="//apple_ref/doc/uid/30001276-BGBBIFDB" title="Asynchronous and Synchronous Modes"></a><h2 class="jump">Asynchronous and Synchronous Modes</h2><p>Several <code>CFNetServices</code> functions can operate in asynchronous or synchronous mode. Scheduling a <code>CFNetService</code> or <code>CFNetServiceBrowser</code> object on a run loop causes the service or browser to operate in asynchronous mode. If a <code>CFNetService</code> or <code>CFNetServiceBrowser</code> object is not scheduled on a run loop, it operates in synchronous mode. Operating in asynchronous mode changes the behavior of its functions.</p><p>Although it is possible to use the synchronous modes of these functions, keep in mind that it is unacceptable to block the user interface or other functions of your program while you wait for synchronous functions to return. Because network operations may take an arbitrary amount of time to complete, it is highly recommended that you use the asynchronous modes of each function.</p><p><span class="content_text">Table A-1</span> describes the differences in behavior between synchronous and asynchronous modes.</p><a name="//apple_ref/doc/uid/30001276-BGBBFHAH" title="Table A-1Behavior of certain CFNetServices functions in asynchronous and synchronous mode "></a><div class="tableholder"><table class="graybox" border = "0" cellspacing="0" cellpadding="5"><caption class="tablecaption"><strong class="caption_number">Table A-1</strong>&nbsp;&nbsp;Behavior of certain <code>CFNetServices</code> functions in asynchronous and synchronous mode </caption><tr><th scope="col" class="TableHeading_TableRow_TableCell"><p>Function</p></th><th scope="col" class="TableHeading_TableRow_TableCell"><p>Asynchronous mode</p></th><th scope="col" class="TableHeading_TableRow_TableCell"><p>Synchronous mode</p></th></tr><tr><td  scope="row"><p><code><!--a-->CFNetServiceRegisterWithOptions<!--/a--></code></p></td><td ><p>Starts the registration and returns. The callback function for the <code>CFNetService</code> is called to report any errors that occur while the service is running. The service is available on the network until your app cancels the registration.</p></td><td ><p>Blocks until your app cancels the service from another thread or until an error occurs, at which point the function returns. If an error occurs, the error is returned through the provided error structure. The service is available on the network until your app cancels the registration or an error occurs.</p></td></tr><tr><td  scope="row"><p><code><!--a-->CFNetServiceResolveWithTimeout<!--/a--></code></p></td><td ><p>Starts the resolution and returns. The callback function for the <code>CFNetService</code> is called to report any errors that occur during resolution. The resolution operation runs until the specified timeout is reached or, if the timeout was specified as zero, until it is canceled.</p></td><td ><p>Blocks until at least one IP address is found for the service, an error occurs, the time specified as the timeout parameter is reached, or your app cancels the resolution, at which point the function returns. If an error occurs, the error is returned through the provided error structure. The resolution operation continues to run until your app cancels it or an error occurs.</p></td></tr><tr><td  scope="row"><p><code><!--a-->CFNetServiceBrowserSearchForDomains<!--/a--></code></p></td><td ><p>Starts the search and returns. The callback function for the <code>CFNetServiceBrowser</code> is called for each domain that is found and when any error occurs while browsing. Browsing continues to run until your app stops the browsing.</p></td><td ><p>Blocks until an error occurs or your app calls <code><!--a-->CFNetServiceBrowserStopSearch<!--/a--></code>, at which time the callback function for the <code>CFNetServiceBrowser</code> is called for each domain that was found. Any error is returned through the provided error structure. Browsing continues until your app stops the browsing operation.</p></td></tr><tr><td  scope="row"><p><code><!--a-->CFNetServiceBrowserSearchForServices<!--/a--></code></p></td><td ><p>Starts the search and returns. The callback function for the <code>CFNetServiceBrowser</code> is called for each <code>CFNetService</code> that is found and when any error occurs while browsing. Browsing continues to run until your app stops the browsing.</p></td><td ><p>Blocks until an error occurs or until your app calls <code><!--a-->CFNetServiceBrowserStopSearch<!--/a--></code>, at which time the callback function for the <code>CFNetServiceBrowser</code> is called for each <code>CFNetService</code> that was found. Any error is returned in the provided error structure. Browsing continues until your app stops the browsing.</p></td></tr></table></div></section><section><a name="//apple_ref/doc/uid/30001276-BGBGDHDD" title="Shutting Down Services and Searches"></a><h2 class="jump">Shutting Down Services and Searches</h2><p>To shut down a service that is running in asynchronous mode, your app unschedules the service from all run loops that it may be scheduled on. The app then calls <code><a href="https://developer.apple.com/documentation/cfnetwork/1426447-cfnetservicesetclient" class="urlLink" target="_self">CFNetServiceSetClient</a></code> with the <code>clientCB</code> parameter set to <code>NULL</code> to disassociate your callback function from the <code>CFNetService</code> object. Finally, the app calls <code><a href="https://developer.apple.com/documentation/cfnetwork/1426533-cfnetservicecancel" class="urlLink" target="_self">CFNetServiceCancel</a></code> to stop the service.</p><p>To shut down a service that is running in synchronous mode, your app only needs to call <code>CFNetServiceCancel</code> from another thread.</p><p><span class="content_text">Listing A-5</span> shows a good example of shutting down an asynchronous <code>CFNetService</code> resolve operation that has not timed out.</p><a name="//apple_ref/doc/uid/30001276-SW4" title="Listing A-5Canceling an asynchronous CFNetService resolve operation"></a><p class="codesample clear"><strong class="caption_number">Listing A-5</strong>&nbsp;&nbsp;Canceling an asynchronous <code>CFNetService</code> resolve operation</p><div class="codesample clear"><table><tr><td scope="row"><pre>void MyCancelResolve(CFNetServiceRef gServiceBeingResolved)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>     assert(gServiceBeingResolved != NULL);<span></span></pre></td></tr><tr><td scope="row"><pre>     CFNetServiceUnscheduleFromRunLoop(gServiceBeingResolved, CFRunLoopGetCurrent(), kCFRunLoopCommonModes);<span></span></pre></td></tr><tr><td scope="row"><pre>     CFNetServiceSetClient(gServiceBeingResolved, NULL, NULL);<span></span></pre></td></tr><tr><td scope="row"><pre>     CFNetServiceCancel(gServiceBeingResolved);<span></span></pre></td></tr><tr><td scope="row"><pre>     CFRelease(gServiceBeingResolved);<span></span></pre></td></tr><tr><td scope="row"><pre>     gServiceBeingResolved = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>     return;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div><p>To shut down a browser that is running in asynchronous mode, your app unschedules the browser from all run loops that it may be scheduled on and then calls <code><a href="https://developer.apple.com/documentation/cfnetwork/1426399-cfnetservicebrowserinvalidate" class="urlLink" target="_self">CFNetServiceBrowserInvalidate</a></code>. Then your app calls <code><a href="https://developer.apple.com/documentation/cfnetwork/1426523-cfnetservicebrowserstopsearch" class="urlLink" target="_self">CFNetServiceBrowserStopSearch</a></code>. If the browser is running in synchronous mode, you only need to call <code>CFNetServiceBrowserStopSearch</code>. An example of these functions can be seen in <span class="content_text">Listing A-6</span>.</p><a name="//apple_ref/doc/uid/30001276-SW6" title="Listing A-6Stop browsing for services"></a><p class="codesample clear"><strong class="caption_number">Listing A-6</strong>&nbsp;&nbsp;Stop browsing for services</p><div class="codesample clear"><table><tr><td scope="row"><pre>static void MyStopBrowsingForServices(CFNetServiceBrowserRef gServiceBrowserRef)<span></span></pre></td></tr><tr><td scope="row"><pre>{<span></span></pre></td></tr><tr><td scope="row"><pre>     CFStreamError streamerror;<span></span></pre></td></tr><tr><td scope="row"><pre>     assert(gServiceBrowserRef != NULL);<span></span></pre></td></tr><tr><td scope="row"><pre>     CFNetServiceBrowserStopSearch(gServiceBrowserRef, &amp;streamerror);<span></span></pre></td></tr><tr><td scope="row"><pre>     CFNetServiceBrowserUnscheduleFromRunLoop(gServiceBrowserRef, CFRunLoopGetCurrent(), kCFRunLoopCommonModes);<span></span></pre></td></tr><tr><td scope="row"><pre>     CFNetServiceBrowserInvalidate(gServiceBrowserRef);<span></span></pre></td></tr><tr><td scope="row"><pre>     CFRelease(gServiceBrowserRef);<span></span></pre></td></tr><tr><td scope="row"><pre>     gServiceBrowserRef = NULL;<span></span></pre></td></tr><tr><td scope="row"><pre>     return;<span></span></pre></td></tr><tr><td scope="row"><pre>}<span></span></pre></td></tr></table></div></section>
        <div id="pageNavigationLinks_bottom" class="pageNavigationLinks">
            <a class='nextLink' rel='next' href='BrowsingForDomains.html'>Next</a><a class='previousLink' rel='prev' href='ResolvingServices.html'>Previous</a>
        </div><br/>
        <div class="copyright"><br/><hr /><div align="center"><p class="content_text" lang="en" dir="ltr"> Copyright &#x00a9; 2013 Apple Inc. All Rights Reserved.  <a href="http://www.apple.com/legal/internet-services/terms/site.html" target="_blank">Terms of Use</a>   |  <a href="http://www.apple.com/privacy/" target="_blank">Privacy Policy</a>  |  Updated: 2013-08-08</p></div></div>

        <div id="pediaWindow">
            <div id="pediaHeader"></div>
            <div id="pediaBody"></div>
        </div>
    </article>

    <div id="blackout">
    <div id="preload"></div>
</div>
<div id="modal" aria-hidden="true">
    <div id="closebox" tabindex="0" aria-label="Close feedback form" role="button"></div>
    <div id="sending" class="hidden">
        <h2 tabindex="0">Sending feedback&hellip;</h2>
        <div id="sending_img"></div>
    </div>
    <div id="error" class="hidden">
        <h2 tabindex="0">We&rsquo;re sorry, an error has occurred.</h2>
        <p>Please try submitting your feedback later.</p>
        <div id="error_icon"></div>
    </div>
    <div id="success" class="hidden">
        <h2 tabindex="0">Thank you for providing feedback!</h2>
        <p>Your input helps improve our developer documentation.</p>
        <div id="thank_you_icon"></div>
    </div>
    
    <form id="feedback" action="#" method="post">
        <div class="left-leaf">
            <h2 id="helpful_title" data-asterisk="a1" tabindex="0">How helpful is this document?</h2>     
            <sup id="a1" class="asterisk" aria-hidden="true">*</sup>

            <div id="star_group" role="radiogroup" aria-required="true">
                <label> 
                    <input class="radio" type="radio" name="helped" value="1" /> 
                    Very helpful
                </label>
                <label> 
                    <input class="radio" type="radio" name="helped" value="2" /> 
                    Somewhat helpful
                </label>
                <label>
                    <input class="radio" type="radio" name="helped" value="3" /> 
                    Not helpful
                </label>
            </div>
        </div>
        <div class="right-leaf">
            <h2>How can we improve this document?</h2>
            <div id="improve" class="checkboxes">
                <label>
                    <input type="checkbox" name="typo" /> 
                    Fix typos or links
                </label>
                <label>
                    <input type="checkbox" name="infoIncorrect" /> 
                    Fix incorrect information
                </label>
                <label>
                    <input type="checkbox" name="needs_examples" /> 
                    Add or update code samples
                </label>
                <label>
                    <input type="checkbox" name="needs_art" /> 
                    Add or update illustrations
                </label>
                <label>
                    <input type="checkbox" name="missingInfo" /> 
                    Add information about...
                </label>
            </div>
        </div>

        <textarea id="comment" name="problem" cols="70" rows="8" placeholder="Please tell us more about your experience with this document" data-asterisk="a2" required></textarea>
        <sup id="a2" class="asterisk" aria-hidden="true">*</sup>

        <p class="fineprint">
            <em aria-hidden="true"><span>*</span> Required information</em>
        </p> 

        <input id="submit" type="button" value="Send" />

        <section id="legal">
            <p>
                To submit a product bug or enhancement request, please visit the 
                <a href="https://developer.apple.com/bugreporter/" target="_blank">Bug Reporter</a> 
                page.
            </p>
            <p>
                Please read <a href="http://www.apple.com/legal/policies/ideas.html" target="_blank">Apple's Unsolicited Idea Submission Policy</a> 
                before you send us your feedback.
            </p> 
        </section>
    </form>
</div>

    
    <script charset="utf-8" src="../../../../../Resources/1282/JavaScript/lib/prototype.js"></script>
    <script src="../../../../../Resources/1282/JavaScript/library.js"></script>
</body>
</html>
